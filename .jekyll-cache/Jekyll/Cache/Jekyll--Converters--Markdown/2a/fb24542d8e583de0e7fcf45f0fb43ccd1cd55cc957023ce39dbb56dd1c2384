I"ú<p>Coursera ê°•ì˜ â€œMachine Learning with TensorFlow on Google Cloud Platformâ€ ì¤‘ ì„¸ ë²ˆì§¸ ì½”ìŠ¤ì¸ <a href="https://www.coursera.org/learn/intro-tensorflow/home">Intro to TensorFlow</a>ì˜ 2ì£¼ì°¨ ê°•ì˜ë…¸íŠ¸ì…ë‹ˆë‹¤.</p>

<hr />

<p><br /></p>

<h2 id="estimator-api">Estimator API</h2>

<hr />

<ul>
  <li><code class="language-plaintext highlighter-rouge">Estimators</code> wrap up a large amount of boilerplate code, on top of the model itself.</li>
</ul>

<p><img src="/img/posts/intro-to-tensorflow/04.png" alt="" class="center-75" /><br />
<span class="caption"></span></p>

<ul>
  <li>From small to big to prod with the <code class="language-plaintext highlighter-rouge">Estimator API</code>
    <ul>
      <li>Quick model</li>
      <li>Checkpointing</li>
      <li>Out-of-memory datasets</li>
      <li>Train / eval / monitor</li>
      <li>Distributed training</li>
      <li>Hyper-parameter tuning on ML-Engine</li>
      <li>Production: serving predictions from a trained model</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">Pre-made estimators</code> that can all be used in the same way.</li>
</ul>

<p><img src="/img/posts/intro-to-tensorflow/05.png" alt="tf.estimator.Estimator" class="center-75" /><br />
<span class="caption">tf.estimator.Estimator</span></p>

<p><br /></p>

<h2 id="pre-made-estimators">Pre-made Estimators</h2>

<hr />

<ul>
  <li>Feature columns tell the model <code class="language-plaintext highlighter-rouge">what inputs to expect</code></li>
</ul>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="n">tf</span>

<span class="n">featcols</span> <span class="o">=</span> <span class="p">[</span> <span class="n">tf</span><span class="p">.</span><span class="n">feature_column</span><span class="p">.</span><span class="n">numeric_column</span><span class="p">(</span><span class="s">"sq_footage"</span><span class="p">),</span> <span class="n">tf</span><span class="p">.</span><span class="n">feature_column</span><span class="p">.</span><span class="n">categorical_column_with_vocabulary_list</span><span class="p">(</span><span class="s">"type"</span><span class="p">,</span> <span class="p">[</span><span class="s">"house"</span><span class="p">,</span> <span class="s">"apt"</span><span class="p">])</span> <span class="p">]</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">estimator</span><span class="p">.</span><span class="n">LinearRegressor</span><span class="p">(</span><span class="n">featcols</span><span class="p">)</span></code></pre></figure>

<ul>
  <li>Under the hood: feature columns take care of packing the inputs into the input vector of the model
    <ul>
      <li>tf.feature_column.<code class="language-plaintext highlighter-rouge">bucketized_column</code></li>
      <li>tf.feature_column.<code class="language-plaintext highlighter-rouge">embedding_column</code></li>
      <li>tf.feature_column.<code class="language-plaintext highlighter-rouge">crossed_column</code></li>
      <li>tf.feature_column.<code class="language-plaintext highlighter-rouge">categorical_column_with_hash_bucket</code></li>
      <li>â€¦</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">Training</code>: feed in training input data and train for 100 epochs</li>
</ul>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">train_input_fn</span><span class="p">():</span>
<span class="err">â€‹</span>	<span class="n">features</span> <span class="o">=</span> <span class="p">{</span><span class="s">"sq_footage"</span><span class="p">:</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span>   <span class="mi">2000</span><span class="p">,</span>   <span class="mi">3000</span><span class="p">,</span>   <span class="mi">1000</span><span class="p">,</span>   <span class="mi">2000</span><span class="p">,</span>   <span class="mi">3000</span><span class="p">],</span>
<span class="err">â€‹</span>			  <span class="s">"type"</span><span class="p">:</span>       <span class="p">[</span><span class="s">"house"</span><span class="p">,</span> <span class="s">"house"</span><span class="p">,</span> <span class="s">"house"</span><span class="p">,</span> <span class="s">"apt"</span><span class="p">,</span> <span class="s">"apt"</span><span class="p">,</span> <span class="s">"apt"</span><span class="p">]}</span>
<span class="err">â€‹</span>       <span class="n">labels</span> <span class="o">=</span>                              <span class="p">[</span><span class="mi">500</span><span class="p">,</span>    <span class="mi">1000</span><span class="p">,</span>   <span class="mi">1500</span><span class="p">,</span>   <span class="mi">700</span><span class="p">,</span>    <span class="mi">1300</span><span class="p">,</span>   <span class="mi">1900</span><span class="p">]</span>
<span class="err">â€‹</span>       <span class="k">return</span> <span class="n">features</span><span class="p">,</span> <span class="n">labels</span>

<span class="n">model</span><span class="p">.</span><span class="n">train</span><span class="p">(</span><span class="n">train_input_fn</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span></code></pre></figure>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Predictions</code>: once trained, the model can be used for prediction</li>
</ul>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">predict_input_fn</span><span class="p">():</span>
<span class="err">â€‹</span>	<span class="n">features</span> <span class="o">=</span> <span class="p">{</span><span class="s">"sq_footage"</span><span class="p">:</span> <span class="p">[</span><span class="mi">1500</span><span class="p">,</span> <span class="mi">1800</span><span class="p">],</span>
<span class="err">â€‹</span>				<span class="s">"type"</span><span class="p">:</span>       <span class="p">[</span><span class="s">"house"</span><span class="p">,</span> <span class="s">"apt"</span><span class="p">]}</span>
<span class="err">â€‹</span>	<span class="k">return</span> <span class="n">features</span>

<span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">predict_input_fn</span><span class="p">)</span></code></pre></figure>

<ul>
  <li>To use a different pre-made estimator, just change the class name and supply appropriate parameters</li>
</ul>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">estimator</span><span class="p">.</span><span class="n">DNNRegressor</span><span class="p">(</span><span class="n">featcols</span><span class="p">,</span> <span class="n">hidden_units</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span></code></pre></figure>

<p><br /></p>

<h2 id="checkpointing">Checkpointing</h2>

<hr />

<ul>
  <li>Model checkpoints
    <ol>
      <li>Continue training</li>
      <li>Resume on failure</li>
      <li>Predict from trained model</li>
    </ol>
  </li>
  <li>Estimators <code class="language-plaintext highlighter-rouge">automatically</code> checkpoint training</li>
</ul>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">estimator</span><span class="p">.</span><span class="n">LinearRegressor</span><span class="p">(</span><span class="n">featcols</span><span class="p">,</span> <span class="s">'./model_trained'</span><span class="p">)</span> <span class="c1"># Where to put the checkpoints
</span><span class="n">model</span><span class="p">.</span><span class="n">train</span><span class="p">(</span><span class="n">train_input_fn</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">%</span><span class="n">ls</span> <span class="n">model_trained</span>

<span class="n">checkpoint</span>                                                     <span class="n">model</span><span class="p">.</span><span class="n">ckpt</span><span class="o">-</span><span class="mf">100.</span><span class="n">meta</span>
<span class="n">graph</span><span class="p">.</span><span class="n">pbtxt</span>                                                    <span class="n">model</span><span class="p">.</span><span class="n">ckpt</span><span class="o">-</span><span class="mf">1.</span><span class="n">data</span><span class="o">-</span><span class="mi">00000</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="mi">00001</span>
<span class="n">model</span><span class="p">.</span><span class="n">ckpt</span><span class="o">-</span><span class="mf">100.</span><span class="n">data</span><span class="o">-</span><span class="mi">00000</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="mi">00001</span>       <span class="n">model</span><span class="p">.</span><span class="n">ckpt</span><span class="o">-</span><span class="mf">1.</span><span class="n">index</span>
<span class="n">model</span><span class="p">.</span><span class="n">ckpt</span><span class="o">-</span><span class="mf">100.</span><span class="n">index</span>                                   <span class="n">model</span><span class="p">.</span><span class="n">ckpt</span><span class="o">-</span><span class="mf">1.</span><span class="n">meta</span></code></pre></figure>

<ul>
  <li>We can now restore and predict with the model</li>
</ul>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">trained_model</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">estimator</span><span class="p">.</span><span class="n">LinearRegressor</span><span class="p">(</span><span class="n">featcols</span><span class="p">,</span> <span class="s">'./model_trained'</span><span class="p">)</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">trained_model</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">pred_input_fn</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">INFO</span><span class="p">:</span><span class="n">tensorflow</span><span class="p">:</span><span class="n">Restoring</span> <span class="n">parameters</span> <span class="k">from</span>
<span class="n">model_trained</span><span class="o">/</span><span class="n">model</span><span class="p">.</span><span class="n">ckpt</span><span class="o">-</span><span class="mi">100</span>

<span class="p">{</span><span class="s">'predictions'</span><span class="p">:</span> <span class="n">array</span><span class="p">([</span><span class="mf">855.93</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)}</span>
<span class="p">{</span><span class="s">'predictions'</span><span class="p">:</span> <span class="n">array</span><span class="p">([</span><span class="mf">859.07</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)}</span></code></pre></figure>

<ul>
  <li>Training also resumes from the last checkpoint</li>
</ul>

<p><br /></p>

<h2 id="training-on-in-memory-datasets">Training on in-memory datasets</h2>

<hr />

<ul>
  <li>In memory data: usually numpy arrays or Pandas dataframes
    <ul>
      <li><code class="language-plaintext highlighter-rouge">tf.estimator.inputs.numpy_input_fn</code></li>
      <li><code class="language-plaintext highlighter-rouge">tf.estimator.inputs.pandas_input_fn</code></li>
    </ul>
  </li>
  <li>Training happens until input is exhausted or number of steps is reached</li>
</ul>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">pandas_train_input_fn</span><span class="p">(</span><span class="n">df</span><span class="p">):</span> <span class="c1"># a Pandas dataframe
</span><span class="err">â€‹</span>	<span class="k">return</span> <span class="n">tf</span><span class="p">.</span><span class="n">estimator</span><span class="p">.</span><span class="n">inputs</span><span class="p">.</span><span class="n">pandas_input_fn</span><span class="p">(</span>
<span class="err">â€‹</span>			<span class="n">x</span> <span class="o">=</span> <span class="n">df</span><span class="p">,</span>
<span class="err">â€‹</span>			<span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">'price'</span><span class="p">],</span>
<span class="err">â€‹</span>			<span class="n">batch_size</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
<span class="err">â€‹</span>			<span class="n">num_epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="err">â€‹</span>			<span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span>
<span class="err">â€‹</span>	<span class="p">)</span>

<span class="c1"># Trains until input exhausted (10 epochs) starting from checkpoint
</span><span class="n">model</span><span class="p">.</span><span class="n">train</span><span class="p">(</span><span class="n">pandas_train_input_fn</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
<span class="c1"># 1000 additional steps from checkpoint
</span><span class="n">model</span><span class="p">.</span><span class="n">train</span><span class="p">(</span><span class="n">pandas_train_fn</span><span class="p">(</span><span class="n">df</span><span class="p">),</span> <span class="n">steps</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="c1"># 1000 steps - might be nothing if checkpoint already there
</span><span class="n">model</span><span class="p">.</span><span class="n">train</span><span class="p">(</span><span class="n">pandas_train_input_fn</span><span class="p">(</span><span class="n">df</span><span class="p">),</span> <span class="n">max_steps</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span></code></pre></figure>

<ul>
  <li>To add a new feature, add it to the list of feature columns and make sure it is present in data frame</li>
</ul>

<p><br /></p>

<h2 id="train-on-large-datasets-with-dataset-api">Train on large datasets with Dataset API</h2>

<hr />

<ul>
  <li>Real World ML Models</li>
</ul>

<p><img src="/img/posts/intro-to-tensorflow/06.png" alt="Reak World ML Models" class="center-75" /><br />
<span class="caption">Reak World ML Models</span></p>

<ul>
  <li>Out-of memory datasets tend to be <code class="language-plaintext highlighter-rouge">sharded into multiple files</code></li>
  <li>Datasets can be created from different file formats. They generate <code class="language-plaintext highlighter-rouge">input functions</code> for Estimators</li>
  <li>Read one CSV file using <code class="language-plaintext highlighter-rouge">TextLineDataset</code></li>
  <li>Datasets handle shuffling, epochs, batching, â€¦</li>
  <li>They support arbitrary transformations with <code class="language-plaintext highlighter-rouge">map()</code></li>
  <li>Datasets help create <code class="language-plaintext highlighter-rouge">input_fn</code>â€™s for Estimators</li>
</ul>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">decode_line</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
<span class="err">â€‹</span>	<span class="n">cols</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">decode_csv</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">recode_defaults</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">],[</span><span class="s">'house'</span><span class="p">],[</span><span class="mi">0</span><span class="p">]])</span>
<span class="err">â€‹</span>	<span class="n">features</span> <span class="o">=</span> <span class="p">{</span><span class="s">'sq_footage'</span><span class="p">:</span> <span class="n">cols</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">'type'</span><span class="p">:</span> <span class="n">cols</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span>
<span class="err">â€‹</span>	<span class="n">label</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="c1"># price
</span><span class="err">â€‹</span>	<span class="k">return</span> <span class="n">features</span><span class="p">,</span> <span class="n">label</span>

<span class="n">dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">TextLineDataset</span><span class="p">(</span><span class="s">"train_1.csv"</span><span class="p">).</span><span class="nb">map</span><span class="p">(</span><span class="n">decode_line</span><span class="p">)</span>

<span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">.</span><span class="n">shuffle</span><span class="p">(</span><span class="mi">1000</span><span class="p">).</span><span class="n">repeat</span><span class="p">(</span><span class="mi">15</span><span class="p">).</span><span class="n">batch</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">input_fn</span><span class="p">():</span>
<span class="err">â€‹</span>	<span class="n">features</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">.</span><span class="n">make_one_shot_iterator</span><span class="p">().</span><span class="n">get_next</span><span class="p">()</span>
<span class="err">â€‹</span>	<span class="k">return</span> <span class="n">features</span><span class="p">,</span> <span class="n">label</span>

<span class="n">model</span><span class="p">.</span><span class="n">train</span><span class="p">(</span><span class="n">input_fn</span><span class="p">)</span></code></pre></figure>

<ul>
  <li>All the tf.commands that you write in Python <strong>do not actually process any data, they just build graphs.</strong></li>
  <li>Common Misconceptions about <code class="language-plaintext highlighter-rouge">input_fn</code>
    <ol>
      <li>Input functions called <code class="language-plaintext highlighter-rouge">only once</code></li>
      <li>Input functions return <code class="language-plaintext highlighter-rouge">tf nodes</code> (not data)</li>
    </ol>
  </li>
  <li>The real benefit of Dataset is that you can do more than just ingest data</li>
</ul>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">TextLineDataset</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>\
<span class="err">â€‹</span>							<span class="p">.</span><span class="n">skip</span><span class="p">(</span><span class="n">num_header_lines</span><span class="p">)</span>\
<span class="err">â€‹</span>							<span class="p">.</span><span class="nb">map</span><span class="p">(</span><span class="n">add_key</span><span class="p">)</span>\
<span class="err">â€‹</span>							<span class="p">.</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">feats</span><span class="p">,</span> <span class="n">labels</span><span class="p">:</span> <span class="n">preproc</span><span class="p">(</span><span class="n">feats</span><span class="p">),</span> <span class="n">labels</span><span class="p">)</span>
<span class="err">â€‹</span>							<span class="p">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">is_valid</span><span class="p">)</span>\
<span class="err">â€‹</span>							<span class="p">.</span><span class="n">cache</span><span class="p">()</span></code></pre></figure>

<p><br /></p>

<h2 id="big-jobs-distributed-training">Big jobs, Distributed training</h2>

<hr />

<ul>
  <li><code class="language-plaintext highlighter-rouge">estimator.train_and_evaluate</code> is the preferred method for training real-world models.</li>
  <li><strong>data parallelism</strong> = replicate your model on multiple workers</li>
</ul>

<p><img src="/img/posts/intro-to-tensorflow/07.png" alt="Distributed training using dataparallelism" class="center-75" /><br />
<span class="caption">Distributed training using dataparallelism</span></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">estimator.train_and_evaluate</code> is the preferred method for training real-world models</li>
</ul>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">estimator</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">estimator</span><span class="p">.</span><span class="n">LineRegressor</span><span class="p">(</span>
<span class="err">â€‹</span>						<span class="n">feature_colimns</span><span class="o">=</span><span class="n">featcols</span><span class="p">,</span>
<span class="err">â€‹</span>						<span class="n">config</span><span class="o">=</span><span class="n">run_config</span><span class="p">)</span>
<span class="p">...</span>
<span class="n">tf</span><span class="p">.</span><span class="n">estimator</span><span class="p">.</span><span class="n">train_and_evaluate</span><span class="p">(</span><span class="n">estimator</span><span class="p">,</span> <span class="n">train_spec</span><span class="p">,</span> <span class="n">eval_spec</span><span class="p">)</span></code></pre></figure>

<ul>
  <li><code class="language-plaintext highlighter-rouge">RunConfig</code> tells the estimator where and how often to write Checkpoints and Tensorboard logs (â€œsummariesâ€)</li>
</ul>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">run_config</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">estimator</span><span class="p">.</span><span class="n">RunConfig</span><span class="p">(</span>
<span class="err">â€‹</span>						<span class="n">model_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span>
<span class="err">â€‹</span>						<span class="n">save_summary_steps</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
<span class="err">â€‹</span>						<span class="n">save_checkpoints_steps</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span>

<span class="n">estimator</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">estimator</span><span class="p">.</span><span class="n">LineRegressor</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">run_config</span><span class="p">,</span> <span class="p">...)</span></code></pre></figure>

<ul>
  <li>The <code class="language-plaintext highlighter-rouge">TrainSpec</code> tells the estimator how to get training data</li>
</ul>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">train_spec</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">estimator</span><span class="p">.</span><span class="n">TrainSpec</span><span class="p">(</span><span class="n">input_fn</span><span class="o">=</span><span class="n">train_input_fn</span><span class="p">,</span> <span class="n">max_steps</span><span class="o">=</span><span class="mi">50000</span><span class="p">)</span>
<span class="p">...</span>
<span class="n">tf</span><span class="p">.</span><span class="n">estimator</span><span class="p">.</span><span class="n">train_and_evaluate</span><span class="p">(</span><span class="n">estimator</span><span class="p">,</span> <span class="n">train_spec</span><span class="p">,</span> <span class="n">eval_spec</span><span class="p">)</span></code></pre></figure>

<ul>
  <li>The <code class="language-plaintext highlighter-rouge">EvalSpec</code> controls the evaluation and the checkpointing of the model since they happen at the same time</li>
</ul>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">eval_spec</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">estimator</span><span class="p">.</span><span class="n">EvalSpec</span><span class="p">(</span>
<span class="err">â€‹</span>					<span class="n">input_fn</span><span class="o">=</span><span class="n">eval_input_fn</span><span class="p">,</span>
<span class="err">â€‹</span>					<span class="n">steps</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="c1"># evals on 100 batches
</span><span class="err">â€‹</span>					<span class="n">throttle_secs</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="c1"># eval no more than every 10 min
</span><span class="err">â€‹</span>					<span class="n">exporters</span><span class="o">=</span><span class="p">...)</span>

<span class="n">tf</span><span class="p">.</span><span class="n">estimator</span><span class="p">.</span><span class="n">train_and_evaluate</span><span class="p">(</span><span class="n">estimator</span><span class="p">,</span> <span class="n">train_spec</span><span class="p">,</span> <span class="n">eval_spec</span><span class="p">)</span></code></pre></figure>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Shuffling</code> is even more important in distributed training</li>
</ul>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">Dataset</span><span class="p">.</span><span class="n">list_files</span><span class="p">(</span><span class="s">"train.csv-*"</span><span class="p">)</span> \
<span class="err">â€‹</span>							<span class="p">.</span><span class="n">shuffle</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>                     \
<span class="err">â€‹</span>							<span class="p">.</span><span class="n">flat_map</span><span class="p">(</span><span class="n">tf</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">TextLineDataset</span><span class="p">)</span>\
<span class="err">â€‹</span>							<span class="p">.</span><span class="nb">map</span><span class="p">(</span><span class="n">decode_csv</span><span class="p">)</span>

<span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">.</span><span class="n">shuffle</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span> \
<span class="err">â€‹</span>							<span class="p">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>   \
<span class="err">â€‹</span>							<span class="p">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span></code></pre></figure>

<p><br /></p>

<h2 id="monitoring-with-tensorboard">Monitoring with TensorBoard</h2>

<hr />

<ul>
  <li>Point Tensorboard to your output directory and the dashboards appear in your browser at localhost:6006</li>
  <li><code class="language-plaintext highlighter-rouge">Pre-made</code> Estimators export relevant metrics, embedding, histograms, etc. for TensorBoard, so there is nothing more to do</li>
</ul>

<p><img src="/img/posts/intro-to-tensorflow/08.png" alt="The dashboard for the graph" class="center-50" /><br />
<span class="caption">The dashboard for the graph</span></p>

<ul>
  <li>If you are writing a custom Estimator model, you can add <code class="language-plaintext highlighter-rouge">summaries</code> for Tensorboard with a single line.
    <ul>
      <li>Sprinkle appropriate summary ops throughout your code:</li>
      <li><code class="language-plaintext highlighter-rouge">tf.summary.scalar</code></li>
      <li><code class="language-plaintext highlighter-rouge">tf.summary.image</code></li>
      <li><code class="language-plaintext highlighter-rouge">tf.summary.audio</code></li>
      <li><code class="language-plaintext highlighter-rouge">tf.summary.text</code></li>
      <li><code class="language-plaintext highlighter-rouge">tf.summary.histogram</code></li>
    </ul>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">tf</span><span class="p">.</span><span class="n">summary</span><span class="p">.</span><span class="n">scalar</span><span class="p">(</span><span class="s">'meanVarl'</span><span class="p">,</span> <span class="n">tf</span><span class="p">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">varl</span><span class="p">))</span>
<span class="p">...</span>
<span class="n">tf</span><span class="p">.</span><span class="n">summary</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s">'outClass'</span><span class="p">,</span> <span class="n">stringvar</span><span class="p">)</span></code></pre></figure>

<p><br /></p>

<h2 id="serving-input-function">Serving Input Function</h2>

<hr />

<ul>
  <li>Recap with all the code</li>
</ul>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">run_config</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">estimator</span><span class="p">.</span><span class="n">RunConfig</span><span class="p">(</span><span class="n">model_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span> <span class="p">...)</span>

<span class="n">estimator</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">estimator</span><span class="p">.</span><span class="n">LineRegressor</span><span class="p">(</span><span class="n">featcols</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">run_config</span><span class="p">)</span>

<span class="n">train_spec</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">estimator</span><span class="p">.</span><span class="n">TrainSpec</span><span class="p">(</span><span class="n">input_fn</span><span class="o">=</span><span class="n">train_input_fn</span><span class="p">,</span> <span class="n">max_steps</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

<span class="n">export_latest</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">estimator</span><span class="p">.</span><span class="n">LatestExporter</span><span class="p">(</span><span class="n">serving_input_receiver_fn</span><span class="o">=</span><span class="n">serving_input_fn</span><span class="p">)</span>

<span class="n">eval_spec</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">estimator</span><span class="p">.</span><span class="n">EvalSpec</span><span class="p">(</span><span class="n">input_fn</span><span class="o">=</span><span class="n">eval_input_fn</span><span class="p">,</span> <span class="n">exporters</span><span class="o">=</span><span class="n">export_latest</span><span class="p">)</span>

<span class="n">tf</span><span class="p">.</span><span class="n">estimator</span><span class="p">.</span><span class="n">train_and_evaluate</span><span class="p">(</span><span class="n">estimator</span><span class="p">,</span> <span class="n">train_spec</span><span class="p">,</span> <span class="n">eval_spec</span><span class="p">)</span></code></pre></figure>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Serving</code> and <code class="language-plaintext highlighter-rouge">training</code>-time inputs are often very <code class="language-plaintext highlighter-rouge">different</code></li>
</ul>

<p><img src="/img/posts/intro-to-tensorflow/09.png" alt="" class="center-75" /><br />
<span class="caption"></span></p>

<ul>
  <li>Serving input function transforms from <code class="language-plaintext highlighter-rouge">parsed JSON data</code> to the <code class="language-plaintext highlighter-rouge">data your model expects</code></li>
</ul>

<p><img src="/img/posts/intro-to-tensorflow/10.png" alt="" class="center-75" /><br />
<span class="caption"></span></p>

<ul>
  <li>The exported model is ready to <code class="language-plaintext highlighter-rouge">deploy</code></li>
  <li>Example serving input function that decodes JPEGs</li>
</ul>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">serving_input_fn</span><span class="p">():</span>
<span class="err">â€‹</span>	<span class="n">json</span> <span class="o">=</span> <span class="p">{</span><span class="s">'jpeg_bytes'</span><span class="p">:</span> <span class="n">tf</span><span class="p">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">tf</span><span class="p">.</span><span class="n">string</span><span class="p">,</span> <span class="p">[</span><span class="bp">None</span><span class="p">])}</span>

<span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="n">jpeg</span><span class="p">):</span>
<span class="err">â€‹</span>	<span class="n">pixels</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">image</span><span class="p">.</span><span class="n">decode_jpeg</span><span class="p">(</span><span class="n">jpeg</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="err">â€‹</span>	<span class="k">return</span> <span class="n">pixels</span>

<span class="n">pics</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">map_fn</span><span class="p">(</span><span class="n">decode</span><span class="p">,</span> <span class="n">json</span><span class="p">[</span><span class="s">'jpeg_bytes'</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="p">.</span><span class="n">unit8</span><span class="p">)</span>

<span class="n">features</span> <span class="o">=</span> <span class="p">{</span><span class="s">'pics'</span><span class="p">:</span> <span class="n">pics</span><span class="p">}</span>
<span class="k">return</span> <span class="n">tf</span><span class="p">.</span><span class="n">estimator</span><span class="p">.</span><span class="n">export</span><span class="p">.</span><span class="n">ServingInputReceiver</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">json</span><span class="p">)</span></code></pre></figure>

:ET